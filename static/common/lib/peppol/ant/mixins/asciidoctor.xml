<?xml version="1.0" encoding="UTF-8"?>
<project name="asciidoctor"
    xmlns:if="ant:if"
    xmlns:unless="ant:unless">

    <macrodef name="asciidoctor-guided">
        <attribute name="source"/>
        <attribute name="target"/>
        <attribute name="error-on" default=""/> <!-- blank equals "FATAL" -->

        <sequential>
            <!-- Generate HTML for all main.adoc files in guide folder. -->
            <apply
                executable="${env.PDK_PATH}/lib/jruby/bin/jruby.bat"
                failonerror="true"
				osfamily="windows">
                <arg value="${env.PDK_PATH}/lib/jruby/bin/asciidoctor"/>
                <arg value="-v"/>
                <arg value="--failure-level" unless:blank="@{error-on}"/>
                <arg value="@{error-on}" unless:blank="@{error-on}"/>
                <arg value="-R"/>
                <arg value="@{source}"/>
                <arg value="-D"/>
                <arg value="@{target}"/>
                <fileset dir="@{source}" includes="**/main.adoc"/>
            </apply>
            <apply
                executable="${env.PDK_PATH}/lib/jruby/bin/jruby"
                failonerror="true"
				osfamily="unix">
                <arg value="${env.PDK_PATH}/lib/jruby/bin/asciidoctor"/>
                <arg value="-v"/>
                <arg value="--failure-level" unless:blank="@{error-on}"/>
                <arg value="@{error-on}" unless:blank="@{error-on}"/>
                <arg value="-R"/>
                <arg value="@{source}"/>
                <arg value="-D"/>
                <arg value="@{target}"/>
                <fileset dir="@{source}" includes="**/main.adoc"/>
            </apply>

            <!-- Rename generated "main.html" files "index.html". -->
            <move todir="@{target}">
                <fileset dir="@{target}" includes="**/main.html"/>
                <filtermapper>
                    <replacestring from="main.html" to="index.html"/>
                </filtermapper>
            </move>

            <!-- Copies folders containing .adocassets -->
            <pathconvert pathsep="," property="filePaths">
                <map from="@{source}/" to="" />
                <regexpmapper from="\${basedir}${file.separator}(.*)\${file.separator}" to="\1/**" />
                <path>
                    <fileset dir="@{source}" casesensitive="yes">
                        <include name="**/.adocassets" />
                    </fileset>
                </path>
            </pathconvert>
            <copy todir="@{target}">
                <fileset dir="@{source}" includes="${filePaths}" excludes="**/.adocassets"/>
            </copy>
        </sequential>
    </macrodef>

</project>
